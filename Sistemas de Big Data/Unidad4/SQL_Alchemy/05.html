<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>SQLAlchemy - Parte 5: El ORM Moderno</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/reset.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/theme/dracula.min.css" id="theme">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root {
            --neon-green: #39ff14;
            --neon-blue: #04d9ff;
            --neon-purple: #bd93f9;
            --neon-pink: #ff79c6;
            --db-orange: #ffb86c;
            --db-gray: #6272a4;
        }

        .reveal {
            font-family: 'Montserrat', sans-serif;
            font-size: 30px;
        }

        .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
            text-transform: none;
            font-family: 'Montserrat', sans-serif;
        }

        .reveal h1 { color: var(--neon-green); font-size: 2.5em; }
        .accent { color: var(--neon-blue); font-weight: bold; }
        .concept { color: var(--neon-purple); font-weight: bold; }
        
        .reveal pre {
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            width: 90%;
            margin: 20px auto;
        }
        .reveal pre code {
            padding: 15px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85em; /* Un pel√≠n m√°s peque√±o para c√≥digo complejo */
            line-height: 1.3;
            max-height: 500px;
        }

        /* Diagrama Unit of Work */
        .uow-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .uow-box {
            padding: 20px;
            border: 2px solid white;
            border-radius: 8px;
            text-align: center;
            width: 200px;
        }
        .uow-session {
            border-color: var(--neon-purple);
            background: rgba(189, 147, 249, 0.1);
        }
        .uow-db {
            border-color: var(--db-orange);
            background: rgba(255, 184, 108, 0.1);
        }
        .arrow-anim {
            font-size: 2em;
            color: var(--neon-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; }
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
</head>
<body>

<div class="reveal">
    <div class="slides">

        <section data-background-gradient="linear-gradient(to bottom right, #282a36, #1a1c2c)">
            <h1>El ORM Moderno</h1>
            <h3>Patrones: Data Mapper & Unit of Work</h3>
            <p><small>Parte 5 de 5</small></p>
            <div style="font-size: 3em; margin-top: 20px;">üèõÔ∏è üîÑ üíæ</div>
        </section>

        <section>
            <h2>El cambio de paradigma</h2>
            <p>Abandonamos `Table` para usar Clases de Python.</p>
            <div class="fragment fade-in" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-top:20px;">
                <h4 class="concept">Patr√≥n Data Mapper</h4>
                <p style="font-size: 0.8em;">
                    A diferencia del patr√≥n <em>Active Record</em> (donde el objeto se guarda a s√≠ mismo: `user.save()`), en SQLAlchemy los objetos son <strong>ignorantes</strong> de la base de datos.
                </p>
                <p style="font-size: 0.8em; color: var(--neon-blue);">
                    Necesitamos un agente externo (la Sesi√≥n) para persistirlos.
                </p>
            </div>
        </section>

        <section>
            <h3>1. El Modelo Declarativo</h3>
            <p>Usamos <strong>Type Hints</strong> de Python para definir el esquema.</p>

            <pre><code class="language-python" data-trim data-noescape>
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy import String

# Clase base que mantiene el cat√°logo (MetaData)
class Base(DeclarativeBase):
    pass

# Nuestra entidad de negocio
class User(Base):
    __tablename__ = "usuario"

    # Mapped[int] indica el tipo en Python
    # mapped_column define configuraciones de DB
    id: Mapped[int] = mapped_column(primary_key=True)
    
    # En muchos casos, SQLAlchemy infiere el tipo SQL del tipo Python
    name: Mapped[str] = mapped_column(String(50))
    is_active: Mapped[bool] = mapped_column(default=True)

    def __repr__(self) -> str:
        return f"User(id={self.id!r}, name={self.name!r})"
            </code></pre>
            <small class="fragment" style="color: var(--neon-pink)">Esto genera la `Table` autom√°ticamente en el fondo.</small>
        </section>

        <section>
            <h3>2. La Sesi√≥n (Session)</h3>
            <p>La Sesi√≥n implementa el patr√≥n <span class="concept">Unit of Work</span>.</p>
            
            <div class="uow-container">
                <div class="uow-box" style="border-color: white;">
                    <strong>Tu C√≥digo</strong><br>
                    <small>user = User()</small>
                </div>
                <div class="arrow-anim">‚ûî</div>
                <div class="uow-box uow-session">
                    <strong>Session</strong><br>
                    <small>Staging Area<br>(Pending...)</small>
                </div>
                <div class="arrow-anim">‚ûî</div>
                <div class="uow-box uow-db">
                    <strong>DataBase</strong><br>
                    <small>INSERT / UPDATE</small>
                </div>
            </div>

            <p class="fragment" style="margin-top: 30px; font-size: 0.7em;">
                Cuando haces <code>session.add(user)</code>, <strong>NO</strong> se ejecuta SQL inmediatamente. La sesi√≥n acumula los cambios hasta que haces <code>commit()</code>.
            </p>
        </section>

        <section>
            <h3>Persistiendo Objetos</h3>
            <pre><code class="language-python" data-trim data-noescape>
from sqlalchemy.orm import Session

# Abrimos la sesi√≥n usando el Engine (creado en Parte 2)
with Session(engine) as session:
    # Instanciamos objetos Python normales
    juan = User(name="Juan", is_active=True)
    ana = User(name="Ana", is_active=False)

    # Los a√±adimos a la "Unit of Work"
    session.add_all([juan, ana])

    # En este punto, 'juan.id' es None.
    
    # Enviamos todo a la BD en una sola transacci√≥n
    session.commit()

    # Ahora 'juan.id' tiene valor (Lazy load tras el commit)
    print(juan.id) 
            </code></pre>
        </section>

        <section>
            <h3>3. Patr√≥n Identity Map</h3>
            <p>La sesi√≥n asegura la unicidad de los objetos en memoria.</p>

            <pre><code class="language-python" data-trim data-noescape>
with Session(engine) as session:
    # Consulta 1: Traer usuario con ID 1
    u1 = session.get(User, 1)
    
    # Consulta 2: Traer usuario con ID 1 (otra vez)
    u2 = session.get(User, 1)

    # ¬øSon el mismo objeto en memoria?
    print(u1 is u2)  
    # Output: True
            </code></pre>
            
            <div class="fragment" style="background: #282a36; border: 1px solid var(--neon-green); padding: 10px; font-size: 0.6em;">
                <strong>Doctoral Note:</strong> La sesi√≥n mantiene un mapa <code>{ (Clase, PK): Instancia }</code>. Si pides algo que ya est√° en el mapa, te devuelve la instancia existente sin consultar la BD, garantizando la consistencia de datos en la transacci√≥n.
            </div>
        </section>

        <section>
            <h3>Querying con ORM</h3>
            <p>Usamos el mismo lenguaje <code>select()</code> de la Parte 4, pero ahora pasamos Clases.</p>

            <pre><code class="language-python" data-trim data-noescape>
from sqlalchemy import select

stmt = select(User).where(User.name == "Juan")

with Session(engine) as session:
    # scalars() se usa para obtener objetos ORM directamente
    # en lugar de tuplas de filas.
    user = session.scalars(stmt).first()
    
    print(user.name)
            </code></pre>
            <p class="fragment" style="font-size: 0.7em;">
                Nota: SQLAlchemy traduce autom√°ticamente los atributos de la clase (<code>User.name</code>) a columnas SQL.
            </p>
        </section>

        <section>
            <h2>Misi√≥n Cumplida</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 0.6em;">
                <span style="border: 1px solid var(--neon-green); padding: 10px; border-radius: 5px;">1. Dialectos</span>
                <span style="border: 1px solid var(--neon-blue); padding: 10px; border-radius: 5px;">2. Engine/Pool</span>
                <span style="border: 1px solid var(--neon-purple); padding: 10px; border-radius: 5px;">3. MetaData</span>
                <span style="border: 1px solid var(--neon-pink); padding: 10px; border-radius: 5px;">4. Expression Language</span>
                <span style="border: 1px solid var(--db-orange); padding: 10px; border-radius: 5px;">5. ORM/Session</span>
            </div>

            <div style="margin-top: 40px;">
                <h4 class="accent">¬øQu√© sigue?</h4>
                <p>Ya dominas los fundamentos de ingenier√≠a de SQLAlchemy.</p>
                <p class="fragment" style="color: var(--neon-green); font-weight: bold;">
                    Pr√≥ximamente: BONUS TRACK<br>
                    <span style="font-size: 0.7em; font-weight: normal; color: white;">Relaciones complejas y Joins en el ORM.</span>
                </p>
            </div>
        </section>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/reveal.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/plugin/highlight/highlight.min.js"></script>

<script>
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        
        width: 960,
        height: 700,
        margin: 0.1,
        minScale: 0.2,
        maxScale: 2.0,

        transition: 'slide', 
        plugins: [ RevealHighlight ]
    });
</script>

</body>
</html>