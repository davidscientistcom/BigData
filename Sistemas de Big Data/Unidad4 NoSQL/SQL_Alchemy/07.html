<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>SQLAlchemy - Bonus Track 2: Modelado Real</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/reset.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/theme/dracula.min.css" id="theme">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root {
            --neon-green: #39ff14;
            --neon-blue: #04d9ff;
            --neon-purple: #bd93f9;
            --neon-pink: #ff79c6;
            --neon-yellow: #f1fa8c;
            --db-bg: #282a36;
        }

        .reveal {
            font-family: 'Montserrat', sans-serif;
            font-size: 30px;
        }

        .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
            text-transform: none;
            font-family: 'Montserrat', sans-serif;
        }

        .reveal h1 { color: var(--neon-yellow); text-shadow: 0 0 10px rgba(241, 250, 140, 0.5); }
        .accent { color: var(--neon-blue); font-weight: bold; }
        .concept { color: var(--neon-green); font-weight: bold; }
        
        .reveal pre {
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
            border-radius: 8px;
            width: 95%;
            margin: 20px auto;
            border: 1px solid #44475a;
        }
        .reveal pre code {
            padding: 15px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.8em;
            line-height: 1.35;
            max-height: 550px;
        }

        /* Diagrama ER Simple CSS */
        .er-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
        }
        .entity {
            border: 2px solid white;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            background: rgba(255,255,255,0.05);
            width: 150px;
            text-align: center;
        }
        .rel-line {
            height: 2px;
            width: 50px;
            background: var(--neon-blue);
            position: relative;
        }
        .rel-desc {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.5em;
            color: var(--neon-purple);
            white-space: nowrap;
        }

        /* Badge de tipo de relaci√≥n */
        .badge {
            font-size: 0.6em;
            padding: 2px 8px;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 10px;
        }
        .b-1t1 { background: var(--neon-pink); color: black; }
        .b-1tm { background: var(--neon-blue); color: black; }
        .b-mtm { background: var(--neon-green); color: black; }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
</head>
<body>

<div class="reveal">
    <div class="slides">

        <section data-background-gradient="linear-gradient(to bottom right, #1a1c2c, #4a3b1c)">
            <h1>Bonus Track 2</h1>
            <h3>Modelado Real y Agregaciones (GROUP BY)</h3>
            <p><small>Caso Pr√°ctico: Sistema de Calificaciones</small></p>
            <div style="font-size: 3em; margin-top: 20px;">üéì üìä üìà</div>
        </section>

        <section>
            <h2>El Escenario Acad√©mico</h2>
            <div class="er-diagram">
                <div class="entity" style="border-color: var(--neon-pink)">Expediente<br><small>(Info Privada)</small></div>
                <div class="rel-line"><span class="rel-desc">1 a 1</span></div>
                <div class="entity" style="border-color: white">Alumno</div>
                <div class="rel-line"><span class="rel-desc">1 a N</span></div>
                <div class="entity" style="border-color: var(--neon-green)">Nota<br><small>(Association)</small></div>
                <div class="rel-line"><span class="rel-desc">N a 1</span></div>
                <div class="entity" style="border-color: var(--neon-blue)">Curso</div>
            </div>
            
            <p class="fragment" style="margin-top: 30px; font-size: 0.7em; text-align: left; padding: 0 50px;">
                <strong>Advertencia:</strong> La relaci√≥n entre Alumno y Curso es "Muchos a Muchos", pero no podemos usar una tabla simple porque necesitamos guardar la <strong>calificaci√≥n</strong>. Usaremos el patr√≥n <em>Association Object</em> (Entidad 'Nota').
            </p>
        </section>

        <section>
            <h3>1. Relaci√≥n Uno a Uno <span class="badge b-1t1">1:1</span></h3>
            <p style="font-size: 0.7em;">Un alumno tiene un solo expediente m√©dico/privado. Si borras al alumno, el expediente debe desaparecer (Cascade).</p>

            <pre><code class="language-python" data-trim data-noescape>
class Expediente(Base):
    __tablename__ = "expediente"
    id: Mapped[int] = mapped_column(primary_key=True)
    seguro_medico: Mapped[str] = mapped_column(String)
    
    # Foreign Key en el lado "d√©bil" de la relaci√≥n
    alumno_id: Mapped[int] = mapped_column(ForeignKey("alumno.id"))

    # uselist=False fuerza la cardinalidad a UNO (en lugar de una lista)
    alumno: Mapped["Alumno"] = relationship(back_populates="expediente")

class Alumno(Base):
    __tablename__ = "alumno"
    id: Mapped[int] = mapped_column(primary_key=True)
    nombre: Mapped[str] = mapped_column(String)
    
    # Acceso directo al objeto (no es una lista)
    expediente: Mapped["Expediente"] = relationship(
        back_populates="alumno", 
        uselist=False, 
        cascade="all, delete-orphan" # Si borro alumno, borro expediente
    )
            </code></pre>
        </section>

        <section>
            <h3>2. Muchos a Muchos con Atributos <span class="badge b-mtm">M:N</span></h3>
            <p style="font-size: 0.7em;">Aqu√≠ est√° la magia. `Nota` conecta `Alumno` y `Curso`, a√±adiendo el valor `valor_nota`.</p>

            <pre><code class="language-python" data-trim data-noescape>
class Nota(Base):
    __tablename__ = "nota"
    # Clave primaria compuesta por las dos FKs
    alumno_id: Mapped[int] = mapped_column(ForeignKey("alumno.id"), primary_key=True)
    curso_id: Mapped[int] = mapped_column(ForeignKey("curso.id"), primary_key=True)
    
    # EL DATO IMPORTANTE:
    valor_nota: Mapped[float] = mapped_column(Float) # Ej: 8.5

    # Relaciones para navegar hacia arriba
    alumno: Mapped["Alumno"] = relationship(back_populates="notas")
    curso: Mapped["Curso"] = relationship(back_populates="notas")

class Curso(Base):
    __tablename__ = "curso"
    id: Mapped[int] = mapped_column(primary_key=True)
    titulo: Mapped[str] = mapped_column(String)
    
    # Un curso tiene muchas notas asignadas
    notas: Mapped[List["Nota"]] = relationship(back_populates="curso")

# En Alumno a√±adimos: notas: Mapped[List["Nota"]] = relationship(...)
            </code></pre>
        </section>

        <section>
            <h3>3. Agregaciones: `func`</h3>
            <p>SQLAlchemy expone funciones SQL est√°ndar (SUM, AVG, COUNT, MAX) a trav√©s del objeto <code>func</code>.</p>
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <code style="color: var(--neon-yellow)">from sqlalchemy import func</code>
            </div>

            <p style="font-size: 0.7em;">Queremos saber: <strong>¬øCu√°l es la nota media de cada alumno?</strong></p>
            <p style="font-size: 0.7em;" class="fragment">SQL Mental: <br><code>SELECT alumno.nombre, AVG(nota.valor_nota) FROM alumno JOIN nota ... GROUP BY alumno.nombre</code></p>
        </section>

        <section>
            <h3>GROUP BY y AVG</h3>
            <p>Construyamos la consulta anal√≠tica.</p>

            <pre><code class="language-python" data-trim data-noescape>
from sqlalchemy import func, desc

stmt = (
    # 1. Seleccionamos el nombre y calculamos el PROMEDIO
    select(
        Alumno.nombre, 
        func.avg(Nota.valor_nota).label("promedio")
    )
    # 2. Hacemos JOIN expl√≠cito para conectar las tablas
    .join(Alumno.notas) 
    
    # 3. Agrupamos los resultados por Alumno
    .group_by(Alumno.nombre)
    
    # 4. Ordenamos: Los mejores primero (Descendente)
    .order_by(desc("promedio"))
)

# Ejecuci√≥n
with Session(engine) as session:
    results = session.execute(stmt).all()
    
    for row in results:
        # row no es un objeto Alumno, es una tupla (nombre, promedio)
        print(f"Alumno: {row.nombre} | Nota Media: {row.promedio:.2f}")
            </code></pre>
        </section>

        <section>
            <h3>Filtrando Grupos (HAVING)</h3>
            <p>¬øY si solo queremos alumnos con media de <strong>sobresaliente (>9)</strong>?</p>
            <p style="font-size: 0.7em;" class="danger">ERROR COM√öN: No puedes usar <code>WHERE</code> para filtrar resultados de agregaciones. Debes usar <code>HAVING</code>.</p>

            <pre><code class="language-python" data-trim data-noescape>
stmt = (
    select(Alumno.nombre, func.avg(Nota.valor_nota))
    .join(Alumno.notas)
    .group_by(Alumno.nombre)
    
    # HAVING se aplica DESPU√âS del GROUP BY
    .having(func.avg(Nota.valor_nota) >= 9.0)
)
            </code></pre>
            
            <div class="fragment" style="border: 1px dashed var(--neon-purple); padding: 10px; font-size: 0.6em; margin-top: 20px;">
                <strong>Nota Doctoral:</strong> `WHERE` filtra filas antes de agrupar. `HAVING` filtra grupos despu√©s de calcular agregaciones. SQLAlchemy respeta estrictamente esta sem√°ntica SQL.
            </div>
        </section>

        <section>
            <h2>Resumen Bonus 2</h2>
            <ul>
                <li><strong>1:1</strong> utiliza <code>uselist=False</code> para garantizar unicidad en Python.</li>
                <li><strong>Association Object:</strong> Transforma un M:N simple en dos relaciones 1:N apuntando a una tabla intermedia con datos (`valor_nota`).</li>
                <li><strong>`func`:</strong> Tu puerta de acceso a <code>AVG</code>, <code>COUNT</code>, <code>SUM</code>.</li>
                <li><strong>Agregaci√≥n:</strong> Recuerda la secuencia sagrada: <br><code>SELECT -> JOIN -> GROUP BY -> HAVING</code>.</li>
            </ul>
        </section>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/reveal.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.4/plugin/highlight/highlight.min.js"></script>

<script>
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        
        width: 960,
        height: 700,
        margin: 0.1,
        minScale: 0.2,
        maxScale: 2.0,

        transition: 'convex', // Transici√≥n 3D
        plugins: [ RevealHighlight ]
    });
</script>

</body>
</html>